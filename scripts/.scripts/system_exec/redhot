#!/usr/bin/env sh
dir="/mnt/PSSD_Storage/bdfr/fav"
cd /mnt/PSSD_Storage/bdfr/

CloseTerm(){
    xdotool windowclose $window 
}

RedhotQuery(){        
    sort=$1
    n=$2
    
    fd .json -X cat {} | jq -s \
    "[ .[] | \
    {title: .title, \
    score: .score, \
    date: .created_utc, \
    permalink: .permalink, \
    name: .name}] \
    | sort_by(.$sort)" \
    | sd '/comments/.*\n|"/r/|"permalink": ' '' \
    | sd '    "name": "t3_' '/' \
    | rg -e "    [A-z].*/.*" \
    | sd '"' '.mp4' \
    | sed '1!G;h;$!d' \
    | head -n"$n"
}

view(){
    subreddits=($(ls $dir | sed '/nohup.out/d'))
    sortType=(date score)
    window=$(xdotool getactivewindow)

    PS3="Enter Subreddit: "
    
    select sub in ${subreddits[@]}
    do
        PS3="Enter Sort Type: "
        select sort in "${sortType[@]}"
        do
            nohup mpv --playlist-start=0 $(csvsort -c $sort -r "$sub"_posts.csv | csvcut -c 'id') &
            sleep 1
            CloseTerm
            exit 1
        done
    done
}

download(){
    echo "Subreddit: "
    read subreddit
    echo "Sort: "
    read srt
    echo "Time: "
    read time

    sudo python3 -m bdfr clone $dir \
    -s "$subreddit" \
    -t $time \
    -S $srt \
    --file-scheme '{POSTID}' \
    --search-existing \
    --no-dupes
}

search(){
        folder="$(echo "$query" | sed 's/ //g')"

        sudo python3 -m bdfr clone /mnt/PSSD_Storage/bdfr/search/$folder -v \
        --subreddit "all" \
        --sort "top" \
        --time "all" \
        --user "DontWorryAboutIt88"\
        --authenticate \
        --file-scheme '{POSTID}' \
        --search "'$query'" 
}

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/opt/anaconda/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/opt/anaconda/etc/profile.d/conda.sh" ]; then
        . "/opt/anaconda/etc/profile.d/conda.sh"
    else
        export PATH="/opt/anaconda/bin:$PATH"
    fi
fi
unset __conda_setup

conda activate bdfr
# <<< conda initialize <<<

case $1 in
    ""| " ")
        view
    ;;

    "-d" | "--download")
        download
    ;;
    
    "-s" | "--search")
        query="$2"
        search
    ;;
esac

#sub='Boutinelababes'
#GetJsonFiles(){fd .json /mnt/PSSD_Storage/bdfr/fav/$sub -X cat {}}
#SortJsonFiles(){
#        jq -s \
#        "[ .[] | \
#         {title: .title, \
#        score: .score, \
#        date: .created_utc, \
#        permalink: .permalink, \
#        name: .name}] | sort_by(.score)"
#}
#
#ReadDetails=$(GetJsonFiles|SortJsonFiles)
#
#PrintValues(){
#        echo "$ReadDetails"|sd '.*/r/|/comments/.*|"name": "t3_' ''
#}
#PrintValues | sd '\n    '  '/'
#
