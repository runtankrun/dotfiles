#!/usr/bin/env sh
dir="/mnt/PSSD_Storage/bdfr/fav"
cd /mnt/PSSD_Storage/bdfr/

CloseTerm(){
    xdotool windowclose $window 
}

RedhotQuery(){        
    DIR=/mnt/PSSD_Storage/bdfr/fav
    SUB="$1"
    SORT_TYPE="$2"
    
    cd $DIR

    GetJsonFiles(){                                
        fd . -p --extension mp4 --extension json --type file $SUB -x echo {.}.json | sort | uniq --repeated
    }
    
    SortJsonFiles(){
        jq -s \
        "[ .[] | \
        {title: .title, \
        score: .score, \
        date: .created_utc, \
        permalink: .permalink, \
        name: .name}] | sort_by(.$SORT_TYPE)"
    }

    ReadDetails=$(cat $(GetJsonFiles)|SortJsonFiles)

    FormatValues(){
        echo "$ReadDetails"|sd '.*/r/|/comments/.*|"name": "t3_' ''
    }

    PrintValues=$(FormatValues | sd '\n    '  '/' | sd '"' '' | rg -e "^$SUB.*$" | sd '\n' '.mp4\n' | sed '1!G;h;$!d')
    nohup mpv $PrintValues 
}

view(){
    subreddits=($(ls $dir | sed '/nohup.out/d'))
    sortType=(date score)
    window=$(xdotool getactivewindow)

    PS3="Enter Subreddit: "
    
    select sub in ${subreddits[@]}
    do
        PS3="Enter Sort Type: "
        select sort in "${sortType[@]}"
        do
            nohup mpv --playlist-start=0 $(csvsort -c $sort -r "$sub"_posts.csv | csvcut -c 'id') &
            sleep 1
            CloseTerm
            exit 1
        done
    done
}

download(){
    echo "Subreddit: "
    read subreddit
    echo "Sort: "
    read srt
    echo "Time: "
    read time

    sudo python3 -m bdfr clone $dir \
    -s "$subreddit" \
    -t $time \
    -S $srt \
    --file-scheme '{POSTID}' \
    --search-existing \
    --no-dupes
}

search(){
        folder="$(echo "$query" | sed 's/ //g')"

        sudo python3 -m bdfr clone /mnt/PSSD_Storage/bdfr/search/ \
        --subreddit "all" \
        --sort "top" \
        --time "all" \
        --user "DontWorryAboutIt88"\
        --authenticate \
        --file-scheme '{POSTID}' \
        --search "'$query'" 
}

# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/opt/anaconda/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/opt/anaconda/etc/profile.d/conda.sh" ]; then
        . "/opt/anaconda/etc/profile.d/conda.sh"
    else
        export PATH="/opt/anaconda/bin:$PATH"
    fi
fi
unset __conda_setup

conda activate bdfr
# <<< conda initialize <<<

case $1 in
    ""| " ")
        view
    ;;

    "-d" | "--download")
        download
    ;;
    
    "-s" | "--search")
        query="$2"
        search
    ;;

    "-S")
        RedhotQuery "$2" "$3"
    ;;
esac
